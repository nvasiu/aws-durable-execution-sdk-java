# Build stage
FROM --platform=linux/amd64 amazoncorretto:21-alpine AS builder

WORKDIR /build

# Copy parent pom and all modules
COPY pom.xml .
COPY sdk ./sdk
COPY sdk-testing ./sdk-testing
COPY sdk-integration-tests ./sdk-integration-tests
COPY examples ./examples

# Install Maven
RUN apk add --no-cache maven

# Build and install the SDK modules first
RUN mvn clean install -DskipTests -pl sdk,sdk-testing -am

# Build the examples project
RUN mvn clean package -DskipTests -pl examples -am

# Runtime stage
FROM public.ecr.aws/lambda/java:21

# Copy only the built JAR from build stage
COPY --from=builder /build/examples/target/*.jar ${LAMBDA_TASK_ROOT}/lib/

# Default CMD (will be overridden by ImageConfig.Command in SAM template)
CMD ["com.amazonaws.lambda.durable.examples.SimpleStepExample::handleRequest"]
